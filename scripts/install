#!/bin/bash

set -e
source /usr/share/yunohost/helpers

app=${app:?}

app_domain=${domain}
app_path=${path%/}
if [ -z "$app_path" ]; then app_path="/"; fi
if [[ "$app_path" != /* ]]; then app_path="/$app_path"; fi
app_port=${app_port}

smtp_host=${smtp_host:-}
smtp_port=${smtp_port:-}
smtp_user=${smtp_user:-}
smtp_pass=${smtp_pass:-}
smtp_from=${smtp_from:-}

ynh_app_setting_set --app="$app" --key=domain --value="$app_domain"
ynh_app_setting_set --app="$app" --key=path --value="$app_path"
ynh_app_setting_set --app="$app" --key=port --value="$app_port"
ynh_app_setting_set --app="$app" --key=smtp_host --value="$smtp_host"
ynh_app_setting_set --app="$app" --key=smtp_port --value="$smtp_port"
ynh_app_setting_set --app="$app" --key=smtp_user --value="$smtp_user"
ynh_app_setting_set --app="$app" --key=smtp_pass --value="$smtp_pass"
ynh_app_setting_set --app="$app" --key=smtp_from --value="$smtp_from"

# Check docker
command -v docker >/dev/null 2>&1 || ynh_die "Docker nicht gefunden. Bitte Docker installieren."

install_dir=$(ynh_app_setting_get --app="$app" --key=install_dir)
data_dir=$(ynh_app_setting_get --app="$app" --key=data_dir)

mkdir -p "$data_dir"

app_url="https://${app_domain}${app_path}"

smtp_host=${smtp_host:-}
smtp_port=${smtp_port:-}
smtp_user=${smtp_user:-}
smtp_pass=${smtp_pass:-}
smtp_from=${smtp_from:-}

cat ../conf/docker-compose.yml \
  | sed "s#__APP__#${app}#g" \
  | sed "s#__APP_URL__#${app_url}#g" \
  | sed "s#__DATA_DIR__#${data_dir}#g" \
  | sed "s#__APP_PORT__#${app_port}#g" \
  | sed "s#__SMTP_HOST__#${smtp_host}#g" \
  | sed "s#__SMTP_PORT__#${smtp_port}#g" \
  | sed "s#__SMTP_USER__#${smtp_user}#g" \
  | sed "s#__SMTP_PASS__#${smtp_pass}#g" \
  | sed "s#__SMTP_FROM__#${smtp_from}#g" \
  > "$install_dir/docker-compose.yml"

# nginx proxy
ynh_add_nginx_config

cd "$install_dir"
if command -v docker-compose >/dev/null 2>&1; then
  docker-compose up -d
else
  docker compose up -d
fi

# permissions already provisioned by resources.permissions
